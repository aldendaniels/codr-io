define(["require","jquery","helpers/helpers-web","./ace/ace"],function(e){var t=e("jquery"),n=e("helpers/helpers-web");return oAce=e("./ace/ace"),AceRange=oAce.require("ace/range").Range,n.createClass({_oAceEditor:null,_oAceEditSession:null,_oAceDocument:null,_sNewLineChar:"",_bApplyingDelta:!1,_bDocumentJustChanged:!1,_iSendSelEventTimeout:null,_oLastAceSelectionRange:null,_oAceMarkerIDMap:null,__type__:"EditControl",__init__:function(e){this._jEditorElem=t(e),this._oAceEditor=oAce.edit(e),this._oAceEditSession=this._oAceEditor.getSession(),this._oAceDocument=this._oAceEditSession.getDocument(),this._sNewLineChar=this._oAceDocument.getNewLineCharacter(),this._oAceEditor.setFontSize(14),this._oAceEditor.setShowPrintMargin(!1),this._oAceEditor.setReadOnly(IS_SNAPSHOT),this._oAceEditor.commands.bindKey("Ctrl-G|Command-G","gotoline"),this._oAceEditor.commands.bindKey("Ctrl-L|Command-L",""),this._oAceEditor.setSelectionStyle("text"),this._oAceEditor.on("blur",function(e){e.preventDefault()}),this._oLastAceSelectionRange=new AceRange(0,0,0,0),this._oAceMarkerIDMap={}},applyDelta:function(e){this._bApplyingDelta=!0;var t=this._denormalizeDelta(e);this._oAceDocument.applyDeltas([t]),this._bApplyingDelta=!1},revertDelta:function(e){this._bApplyingDelta=!0;var t=this._denormalizeDelta(e);this._oAceDocument.revertDeltas([t]),this._bApplyingDelta=!1},setMode:function(e){this._oAceEditSession.setMode(e.getPath())},setContent:function(e){this._bApplyingDelta=!0,this._oAceDocument.setValue(e.join(this._sNewLineChar)),this._oAceEditor.moveCursorTo(0,0),this._bApplyingDelta=!1},setSelectionMarker:function(e,t,n){t in this._oAceMarkerIDMap&&this.removeSelectionMarker(t);var r=e.oStart.iRow==e.oEnd.iRow&&e.oStart.iCol==e.oEnd.iCol,i=this._denormalizeRange(e),s=[];r?(i.end.column+=1,s.push(this._oAceEditSession.addMarker(i,"remote-sel-collapsed "+n,"text")),s.push(this._oAceEditSession.addMarker(i,"remote-sel-collapsed-hat "+n,"text"))):s.push(this._oAceEditSession.addMarker(i,"remote-sel "+n,"text")),this._oAceMarkerIDMap[t]=s},removeSelectionMarker:function(e){if(!e in this._oAceMarkerIDMap)return;var t=this._oAceMarkerIDMap[e];for(var n in t)this._oAceEditSession.removeMarker(t[n]);delete this._oAceMarkerIDMap[e]},resize:function(){this._oAceEditor.resize()},focus:function(){this._oAceEditor.focus()},on:function(e,t,r){r=n.createCallback(t,r);switch(e){case"docChange":this._oAceEditor.on("change",n.createCallback(this,function(e){this._bDocumentJustChanged=!0,clearTimeout(this._iSendSelEventTimeout),this._bApplyingDelta||r(this._normalizeAceDelta(e.data))}));break;case"selChange":this._oAceEditor.on("changeSelection",n.createCallback(this,function(e){var t=this._oAceEditor.getSelectionRange(),i=this._oLastAceSelectionRange.isEqual(t);this._oLastAceSelectionRange=t;if(i)return;this._iSendSelEventTimeout&&clearTimeout(this._iSendSelEventTimeout);var s=this._normalizeAceRange(t);this._iSendSelEventTimeout=window.setTimeout(n.createCallback(this,function(){r(s,this._bDocumentJustChanged),this._bDocumentJustChanged=!1}),1)}));break;default:n.assert(!1,"Invalid event type "+e)}},_normalizeAceDelta:function(e){var t=this._normalizeAceRange(e.range);switch(e.action){case"insertText":return{sAction:"insert",oRange:t,aLines:e.text.split(this._sNewLineChar)};case"removeText":return{sAction:"delete",oRange:t,aLines:e.text.split(this._sNewLineChar)};case"insertLines":return{sAction:"insert",oRange:t,aLines:e.lines.concat([""])};case"removeLines":return{sAction:"delete",oRange:t,aLines:e.lines.concat([""])};default:n.assert(!1,"Invalid AceDelta type: "+e.action)}return null},_denormalizeDelta:function(e){var t=this._denormalizeRange(e.oRange);switch(e.sAction){case"insert":return{action:"insertText",range:t,text:e.aLines.join(this._sNewLineChar)};case"delete":return{action:"removeText",range:t,text:e.aLines.join(this._sNewLineChar)};default:n.assert(!1,"Invalid delta type.")}return null},_normalizeAceRange:function(e){return{oStart:{iRow:e.start.row,iCol:e.start.column},oEnd:{iRow:e.end.row,iCol:e.end.column}}},_denormalizeRange:function(e){return new AceRange(e.oStart.iRow,e.oStart.iCol,e.oEnd.iRow,e.oEnd.iCol)}})});