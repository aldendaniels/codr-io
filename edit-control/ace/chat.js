define(["require","jquery","helpers/helpers-web"],function(e){var t=e("jquery"),n=e("helpers/helpers-web");return n.createClass({_oSocket:null,_oWorkspace:null,_aHistory:null,_aTypingUsers:null,_bTyping:!1,_iTypingTimeout:null,_iUnseen:0,_bChatVisible:!1,__type__:"PeoplePane",__init__:function(e,t){this._oSocket=t,this._oWorkspace=e,this._aCurUsers=[],this._aHistory=[],this._aTypingUsers=[],this._oSocket.bind("message",this,this._handleServerAction)},onOpen:function(){this._bChatOpen=!0,this._iUnseen=0,this._reRender()},onClose:function(){console.log("on close"),this._bChatOpen=!1},onEvent:function(e){var r=t(e.target),i=t(document.activeElement),s=e.type;if(s=="click"){r.is("#chat-identify-ok-button")&&this._changeClientID(t("#chat-identify").val());return}if(s=="keypress"){if(i.closest("#chat-identify-wrapper").length){e.which==13&&this._changeClientID(t("#chat-identify").val());return}r.is("#chat-box")&&(e.which==13?(this._clearTyping(),this._sendNewMessage(t("#chat-box").val()),t("#chat-box").val(""),e.preventDefault()):(this._bTyping||(this._oSocket.send("startTyping"),this._bTyping=!0),this._iTypingTimeout&&window.clearTimeout(this._iTypingTimeout),this._iTypingTimeout=window.setTimeout(n.createCallback(this,this._clearTyping),1e3)))}s=="blur"&&r.is("#username")&&this._changeClientID(r.val())},_showChatBox:function(){if(this._bChatVisible)return;t("#chat").removeClass("identify"),t("#chat-identify").prop("disabled",!0),t("#chat-identify-ok-button").prop("disabled",!0),t("#chat-box").prop("disabled",!1);var e=t(document.activeElement);e.parents(".toolbar-item").is("#chat-menu")&&t("#chat-box").focus(),this._bChatVisible=!0},_handleServerAction:function(e){switch(e.sType){case"newChatMessage":this._addNewChatMessage(e.oData.sClientID,e.oData.sMessage);break;case"startTyping":this._aTypingUsers.push(e.oData.sClientID),this._reRender();break;case"endTyping":this._aTypingUsers.splice(this._aTypingUsers.indexOf(e.oData.sClientID),1),this._reRender();break;case"invalidClientIDChange":t("#chat-identify-error-message").text(e.oData.sReason);break;case"newClientIDAccepted":this._oWorkspace.getUserInfo().sClientID=e.oData.sClientID,this._showChatBox();break;case"connect":e.oData.bLoggedIn&&this._showChatBox();default:return!1}return!0},_addNewChatMessage:function(e,t){this._bChatOpen||this._iUnseen++,this._aHistory.push({sClientID:e,sMessage:t}),this._reRender()},_changeClientID:function(e){this._oSocket.send("changeClientID",{sClientID:e})},_sendNewMessage:function(e){e=e.replace(/^\s+|\s+$/g,"");if(!e)return;this._oSocket.send("newChatMessage",{sMessage:e}),this._aHistory.push({sClientID:this._oWorkspace.getUserInfo().sClientID,sMessage:e}),this._reRender()},_reRender:function(){var e=t("#chat-history");e.empty();for(var n=0;n<this._aHistory.length;n++){var r=this._aHistory[n],i=t('<div class="chat-message"><span class="chat-message-from"></span><span class="chat-message-text"></span></div>');i.find(".chat-message-from").text(r.sClientID+": "),i.find(".chat-message-text").text(r.sMessage),e.append(i)}t("#chat-typing-names").text(this._englishFormatArray(this._aTypingUsers)),t("#chat-unread-count").text(this._iUnseen),t("#chat-unread-count").toggle(!!this._iUnseen)},_englishFormatArray:function(e){return e.length===0?"":e.length===1?e[0]:e.length===2?e.join(" and "):e.slice(0,-1).join(", ")+" and "+e[e.length-1]},_clearTyping:function(){window.clearTimeout(this._iTypingTimeout),this._bTyping=!1,this._iTypingTimeout=null,this._oSocket.send("endTyping")},_isPaneOpen:function(){return t("#workspace").hasClass("people-pane-expanded")}})});