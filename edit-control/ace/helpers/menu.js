define(["require","jquery","helpers/helpers-web","helpers/keyable"],function(e){var t=e("jquery"),n=e("helpers/helpers-web"),r=e("helpers/keyable");return n.createClass({_aFavOptions:null,_aNormalOptions:null,_iNumFavorites:0,_fnOnSelect:null,_jMenu:null,_oKeyable:null,_sLastQuery:"",__init__:function(e,i,s,o,u,a,f){this._aNormalOptions=e.slice(s),this._aFavOptions=e.slice(0,s),this._oOptionsByKey={};for(var l in e){var c=e[l];this._oOptionsByKey[u(c)]=c}this._fnGetKey=n.createCallback(o,u),this._fnGetDisplayText=n.createCallback(o,a),this._fnOnSelect=n.createCallback(o,f),this._jMenu=t('<div class="menu" ><div class="menu-search"><input type="text" autocomplete="off"/></div><div class="menu-options" tabIndex="-1"></div></div>'),this._oKeyable=new r(this._jMenu),this._renderOptions(),t(i).append(this._jMenu),this._oKeyable.attach(),this._oKeyable.update()},focusInput:function(){this._jMenu.find(".menu-search input").focus()},onEvent:function(e){var n=t(e.target),r=t(".menu").hasClass("disabled");switch(e.type){case"click":var i=n.closest(".option");i.length&&!r&&(this._oKeyable.select(i),this._selectCur());break;case"keyup":this._assertInputFocus();var s=this._jMenu.find(".menu-search input").val();this._sLastQuery!=s&&this._renderOptions(s),this._sLastQuery=s;break;case"keydown":this._assertInputFocus();switch(e.which){case 40:this._oKeyable.moveDown(),this._scrollIntoView(this._oKeyable.getSelected()),e.preventDefault();break;case 38:this._oKeyable.moveUp(),this._scrollIntoView(this._oKeyable.getSelected()),e.preventDefault();break;case 13:r||(this._selectCur(),e.preventDefault())}}},highlight:function(e){var t=this._jMenu.find(".option"+this._fnGetKey(e));n.assert(t.length,"Option not visible. "),this._oKeyable.select(t),this._scrollIntoView(t)},_renderOptions:function(e){var n=this._jMenu.children(".menu-options");n.empty();var r=(e||"").toLowerCase(),i=this._grepOptions(this._aFavOptions,r),s=this._grepOptions(this._aNormalOptions,r);if(i.length){var o=t('<div class="menu-favs"></div>').appendTo(n);for(var u=0;u<i.length;u++)this._appendOption(o,i[u])}for(var u=0;u<s.length;u++)this._appendOption(n,s[u]);this._oKeyable.update()},_grepOptions:function(e,r){return t.grep(e,n.createCallback(this,function(e){return this._fnGetDisplayText(e).toLowerCase().indexOf(r)!=-1}))},_appendOption:function(e,n){var r=t('<div class="option keyable mode"></div>');r.text(this._fnGetDisplayText(n)).attr("id",this._fnGetKey(n)),e.append(r)},_scrollIntoView:function(e){var t=e.offsetParent(),n=e.position().top-parseInt(t.css("paddingTop")),r=t[0].clientHeight-(n+e[0].offsetHeight),i=null;n<0?(i=t.scrollTop()+n,t.scrollTop(i)):r<0&&(i=t.scrollTop()-r,t.scrollTop(i))},_selectCur:function(){var e=this._oKeyable.getSelected().attr("id");this._fnOnSelect(this._oOptionsByKey[e]),this._jMenu.find("input").val(""),this._renderOptions()},_assertInputFocus:function(){document.activeElement!=this._jMenu.find(".menu-search input")[0]&&n.assert(!1,"The menu input does not have focus.")}})});