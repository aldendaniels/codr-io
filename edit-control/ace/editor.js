define(["require","jquery","helpers/helpers-web","edit-control/edit-control","OT"],function(e){var t=e("jquery"),n=e("helpers/helpers-web"),r=e("edit-control/edit-control"),i=e("OT"),s=["green","pink","orange","purple","red","turquoise "],o="edit";return n.createClass({_oSocket:null,_oEditControl:null,_oRemoteClients:null,_iServerState:0,_aServerUnseenQueue:null,__type__:"Editor",__init__:function(e){this._oSocket=e,this._oRemoteClients={},this._aServerUnseenQueue=[],this._oSocket.bind("message",this,this._handleServerAction),this._oEditControl=new r(o),this._oEditControl.on("docChange",this,this._onDocumentChange),this._oEditControl.on("selChange",this,this._onSelectionChange),this._setPeopleViewing()},setMode:function(e){this._oEditControl.setMode(e)},resize:function(){this._oEditControl.resize()},contains:function(e){return e.closest("#"+o).length>0||e.closest(this._jSummaryBar).length>0},focus:function(){this._oEditControl.focus()},onBlur:function(){},onEvent:function(){},setContent:function(e){this._oEditControl.setContent(e)},_handleServerAction:function(e){switch(e.sType){case"setDocumentData":this._iServerState=e.oData.iServerState,this.setContent(e.oData.aLines);break;case"setRemoteSelection":for(var t=0;t<this._aServerUnseenQueue.length;t++)e.oData.oRange=i.transformRange(this._aServerUnseenQueue[t],e.oData.oRange);var r=e.oData.sClientID;this._oRemoteClients[r].oLastSelRange=e.oData.oRange,this._refreshRemoteSelections();break;case"docChange":this._iServerState=e.oData.iServerState;for(var t=this._aServerUnseenQueue.length-1;t>=0;t--){var o=this._aServerUnseenQueue[t],u=n.deepCloneObj(o);u.sAction=o.sAction=="insert"?"delete":"insert",this._applyDelta(u)}this._applyDelta(e.oData.oDelta);for(var t=0;t<this._aServerUnseenQueue.length;t++)o=this._aServerUnseenQueue[t],o.oRange=i.transformRange(e.oData.oDelta,o.oRange),this._applyDelta(o);this._refreshRemoteSelections();break;case"eventReciept":this._iServerState=e.oData.iServerState,this._aServerUnseenQueue.splice(0,1);break;case"addClient":var a=Object.keys(this._oRemoteClients).length;this._oRemoteClients[e.oData.sClientID]={sColor:a<=s.length?s[a]:"black",oLastSelRange:null,aAceMarkersIDs:[]},this._setPeopleViewing();break;case"removeClient":this._oEditControl.removeSelectionMarker(e.oData.sClientID),delete this._oRemoteClients[e.oData.sClientID],this._setPeopleViewing();break;default:return!1}return!0},_setPeopleViewing:function(){var e=Object.keys(this._oRemoteClients).length,n=e+" other"+(e==1?"":"s");t("#num-viewing").text(n).toggleClass("others-viewing",e>0)},_onSelectionChange:function(e,n){n||this._oSocket.send("setSelection",{oRange:e,iState:this._iServerState}),t("#line-num").text(e.oStart.iRow+1),t("#col-num").text(e.oStart.iCol+1)},_onDocumentChange:function(e){this._oSocket.send("docChange",{oDelta:e,iState:this._iServerState}),this._transformRemoteSelections(e),this._refreshRemoteSelections(),this._aServerUnseenQueue.push(e)},_transformRemoteSelections:function(e){for(var t in this._oRemoteClients){var n=this._oRemoteClients[t];n.oLastSelRange&&(n.oLastSelRange=i.transformRange(e,n.oLastSelRange))}},_refreshRemoteSelections:function(){for(var e in this._oRemoteClients){var t=this._oRemoteClients[e];t.oLastSelRange&&this._oEditControl.setSelectionMarker(t.oLastSelRange,e,t.sColor)}},_applyDelta:function(e){this._oEditControl.applyDelta(e),this._transformRemoteSelections(e)}})});