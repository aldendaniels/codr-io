define(["require","jquery","helpers/helpers-web","edit-control/modes","chat","lib/jquery.ui-selectors"],function(e){var t=e("jquery"),n=e("helpers/helpers-web"),r=e("edit-control/modes"),i=e("chat");return e("lib/jquery.ui-selectors"),n.createClass({_oSocket:null,_oWorkspace:null,_oModeMenu:null,_oChat:null,__type__:"Toolbar",__init__:function(e,n,s){this._oSocket=n,this._oWorkspace=e,this._oModeMenu=r.createModeMenu("#mode-menu",this,this._setModeToLocal),this._oChat=new i(e,n),this._oSocket.bind("message",this,this._handleServerAction),s.registerShortcut("T",t("#title-shortcut-wrapper"),"right",20),s.registerShortcut("L",t("#mode-shortcut-wrapper"),"right",20),s.registerShortcut("D",t("#download-menu-shortcut-wrapper"),"right"),s.registerShortcut("F",t("#fork-menu-shortcut-wrapper"),"right"),s.registerShortcut("S",t("#settings-menu-shortcut-wrapper"),"right"),IS_SNAPSHOT||(s.registerShortcut("C",t("#chat-menu-shortcut-wrapper"),"right"),s.registerShortcut("K",t("#link-menu-shortcut-wrapper"),"right")),IS_SNAPSHOT&&(t(".menu").addClass("disabled"),t("#title-input, #title-save").prop("disabled",!0),t("#title .hidden-focusable a").attr("tabIndex",-1),t(".edit-mode-message").show())},setTitle:function(e){t("#title .toolbar-item-selection").text(e),t("#title-input").val(e),t("#download-as").val(e),t("#title .toolbar-item-btn").attr("title",e)},setMode:function(e){t("#mode .toolbar-item-selection").text(e.getDisplayName())},contains:function(e){return e.closest("#toolbar-top,#toolbar-left,#snapshot-notify-bar").length>0},focus:function(){n.assert(!1,"The toolbar should only receive focus manually.")},onBlur:function(){this._closeOpenDropdown()},onEvent:function(e){var n=t(e.target),r=t(document.activeElement),i=e.type,s=n.parents(".toolbar-item"),o=r.parents(".toolbar-item");if(i=="mousedown"){if(n.closest(".toolbar-item-btn").length){s[0]==o[0]?this._blur():(this._closeOpenDropdown(),s.is(".disabled")||this._openDropdown(s));return}if(o.length&&!s.length){this._blur();return}}if(i=="focusin"){var u=t(".toolbar-item.open");o.length?u.length?u.is(o)||(this._closeOpenDropdown(),this._openDropdown(o)):this._openDropdown(o):this._closeOpenDropdown();return}if(i=="keydown"){if(o.is("#title")&&e.which==13){this._setTitleToLocal(),e.preventDefault();return}if(o.is("#download-menu")&&e.which==13){this._download();return}}if(i=="click"){if(n.is("#title-save")){this._setTitleToLocal();return}if(n.closest("#download").length){this._download();return}n.is("#snapshot-button")&&this._oSocket.send("snapshotDocument")}if(o.is("#mode")){this._oModeMenu.onEvent(e);return}if(o.is("#chat-menu")){this._oChat.onEvent(e);return}},_openDropdown:function(e){e.hasClass("open")||(e.addClass("open"),e.find(":focusable").first().focus().select()),e.is("#chat-menu")&&this._oChat.onOpen()},_closeOpenDropdown:function(){var e=t(".toolbar-item.open");e.removeClass("open").scrollTop(0),e.is("#chat-menu")&&this._oChat.onClose()},_blur:function(){this._oWorkspace.blurFocusedObject(this)},_setModeToLocal:function(e){this._oSocket.send("setMode",{sMode:e.getName()}),this.setMode(e),this._oWorkspace.setEditorMode(e),this._blur()},_setTitleToLocal:function(){var e=t("#title-input").val();this._oSocket.send("setDocumentTitle",{sTitle:e}),this.setTitle(e),this._blur()},_download:function(){var e=window.location.href;e[-1]!="/"&&(e+="/");var n=t("#download-as").val();window.location.href=e+"download?filename="+n,this._blur()},_handleServerAction:function(e){switch(e.sType){case"addSnapshot":t("#snapshots #placeholder").remove();var r=document.location.origin+"/v/"+e.oData.sID,i=n.formatDateTime(e.oData.oDateCreated),s=t('<a class="snapshot-link"><span class="date"></span><span class="url"></span></a>');s.find("span.date").text(i),s.find("span.url").text(r),s.attr("href",r).appendTo("#snapshots");break;default:return!1}return!0}})});